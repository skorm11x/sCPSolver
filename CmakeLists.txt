set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
cmake_minimum_required(VERSION 4.0)
project(scpsolver LANGUAGES CXX VERSION 0.1.0)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

option(COVERAGE "Enable code coverage flag" ON)

if(COVERAGE AND (CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang"))
    add_compile_options(
      $<$<CONFIG:Debug>:-fprofile-instr-generate>
      $<$<CONFIG:Debug>:-fcoverage-mapping>
      $<$<CONFIG:Debug>:-O0>
    )
    add_link_options(
      $<$<CONFIG:Debug>:-fprofile-instr-generate>
    )
endif()

include(FetchContent)

# useful function declaration in cmakelists for dynamic libraries
function(add_or_fetch_lib lib_name git_repo git_tag)
  set(lib_dir "${CMAKE_SOURCE_DIR}/lib/${lib_name}")

  if(EXISTS "${lib_dir}/CMakeLists.txt")
    message(STATUS "Using existing ${lib_name} from ${lib_dir}")
    add_subdirectory(${lib_dir})
  else()
    message(STATUS "Fetching ${lib_name} via FetchContent")

    FetchContent_Declare(
      ${lib_name}
      GIT_REPOSITORY ${git_repo}
      GIT_TAG ${git_tag}
      SOURCE_DIR ${lib_dir}
    )

    FetchContent_MakeAvailable(${lib_name})
  endif()
endfunction()

# TODO: handle or-tools per isa, for now assume dev setup involves library 
# TODO: handle civetweb upgrades (open pr), for now assume dev setup involves library
# e.g. 3/5 can be stored
# add_or_fetch_lib(civetweb https://github.com/civetweb/civetweb.git v1.16)
add_or_fetch_lib(nlohmann_json https://github.com/nlohmann/json.git v3.11.3)
add_or_fetch_lib(json_schema_validator https://github.com/pboettch/json-schema-validator.git 2.3.0)
add_or_fetch_lib(googletest https://github.com/google/googletest.git 03597a01ee50ed33e9dfd640b249b4be3799d395)

add_executable(scpsolver
    src/main.cpp
    src/server.cpp
    src/routes.cpp
    src/routes/RootHandler.cpp
    src/routes/CSPSolverHandler.cpp
    src/engine/CSPScheduler.cpp
    src/util/SchemaValidator.cpp
    lib/civetweb/src/CivetServer.cpp
)

target_include_directories(scpsolver PRIVATE ${CMAKE_SOURCE_DIR}/lib/civetweb/include)

set_target_properties(scpsolver PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/bin"
)

add_executable(scpsolver_test
    tests/main_test.cpp
    tests/routes_test.cpp
    src/server.cpp
    src/routes.cpp
    src/routes/RootHandler.cpp
    src/routes/CSPSolverHandler.cpp
    src/engine/CSPScheduler.cpp
    src/util/SchemaValidator.cpp
    lib/civetweb/src/CivetServer.cpp
)

target_include_directories(scpsolver_test PRIVATE
    ${CMAKE_BINARY_DIR}/_deps/googletest/googletest/include/gtest
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/lib/civetweb/include
)

target_link_directories(scpsolver_test PRIVATE ${CMAKE_SOURCE_DIR}/lib/civetweb)

set_target_properties(scpsolver_test PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/bin"
)

if(APPLE)
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64|arm")
        set(ORTOOLS_ROOT "${CMAKE_SOURCE_DIR}/lib/or-tools-9.14.6206/mac-arm")
    else()
        message(FATAL_ERROR "wip macOS architecture: ${CMAKE_SYSTEM_PROCESSOR}")
    endif()

    find_package(ortools REQUIRED PATHS ${ORTOOLS_ROOT}/lib/cmake/ortools NO_DEFAULT_PATH)
    target_link_libraries(scpsolver 
      PRIVATE 
      ortools::ortools 
      civetweb 
      Threads::Threads 
      dl    
      nlohmann_json::nlohmann_json
      nlohmann_json_schema_validator
    )
    target_link_directories(scpsolver PRIVATE ${CMAKE_SOURCE_DIR}/lib/civetweb)

    set_target_properties(scpsolver PROPERTIES
        BUILD_RPATH "/lib/civetweb"
        INSTALL_RPATH "/lib/civetweb"
        MACOSX_RPATH ON
    )

    target_link_libraries(scpsolver_test
      PRIVATE 
      GTest::gtest 
      GTest::gtest_main
      ortools::ortools  
      civetweb 
      curl
      Threads::Threads
      nlohmann_json::nlohmann_json
      nlohmann_json_schema_validator
    )

    if(COVERAGE AND (CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang"))
        target_compile_options(scpsolver_test PRIVATE 
          $<$<CONFIG:Debug>:-fprofile-instr-generate>
          $<$<CONFIG:Debug>:-fcoverage-mapping>
          $<$<CONFIG:Debug>:-O0>
        )
        target_link_options(scpsolver_test PRIVATE 
          $<$<CONFIG:Debug>:-fprofile-instr-generate>
        )
    endif()
else()
    target_link_libraries(scpsolver PRIVATE civetweb Threads::Threads dl)
endif()

enable_testing()
add_test(NAME AllTests COMMAND scpsolver_test)


find_package(Doxygen)
if(Doxygen_FOUND)
  set(DOXYGEN_IN ${CMAKE_CURRENT_SOURCE_DIR}/Doxyfile.in)
  set(DOXYGEN_OUT ${CMAKE_CURRENT_BINARY_DIR}/Doxyfile)

  configure_file(${DOXYGEN_IN} ${DOXYGEN_OUT} @ONLY)

  doxygen_add_docs(
    docs
    ${PROJECT_SOURCE_DIR}
    WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
    COMMENT "Generating API documentation with Doxygen"
    CONFIG_FILE ${DOXYGEN_OUT}
  )
endif()
